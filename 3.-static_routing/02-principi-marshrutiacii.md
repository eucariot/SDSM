# Принципы маршрутизации

Перед началом настройки стоит определиться с тем, для чего нужна маршрутизация вообще.  
Рассмотрим такую сеть:  
![](http://img-fotki.yandex.ru/get/6103/83739833.16/0_82ffe_81ef48b2_XL.jpg)

Вот к примеру с компьютера ПК1 — 172.16.3.2 я хочу подключиться по telnet к L3-коммутатору с адресом 172.16.17.1.  
Как мой компьютер узнает что делать? Куда слать данные?

1\) Как вы уже знаете, если адрес получателя из другой подсети, то данные нужно отправлять на шлюз по умолчанию.  
2\) По уже известной вам схеме компьютер с помощью ARP-запроса добывает MAC-адрес маршрутизатора.  
3\) Далее он формирует кадр с инкапсулированным в него пакетом и отсылает его в порт. После того, как кадр отправлен, компьютеру уже по барабану, что происходит с ним дальше.  
4\) А сам кадр при этом попадает сначала на коммутатор, где решается его судьба согласно таблице MAC-адресов. А потом достигает маршрутизатора RT1.  
5\) Поскольку маршрутизатор ограничивает широковещательный домен — здесь жизнь этого кадра и заканчивается. Циска просто откидывает заголовок канального уровня — он уже не пригодится — извлекает из него IP-пакет.  
6\) Теперь маршрутизатор должен принять решение, что с ним делать дальше. Разумеется, отправить его на какой-то свой интерфейс. Но на какой?  
Для этого существует таблица маршрутизации, которая есть на любом рутере. Выяснить, что у нас в данный момент находится в таблице маршрутизации, можно с помощью команды **show ip route**:

```text
172.16.0.0/16 is variably subnetted, 10 subnets, 3 masks
C 172.16.3.0/24 is directly connected, FastEthernet0/0.101
C 172.16.2.0/30 is directly connected, FastEthernet0/1.4
S 172.16.17.0/24 [1/0] via 172.16.2.2
```

Каждая строка в ней — это способ добраться до той или иной сети.  
Вот к примеру, если пакет адресован в сеть 172.16.17.0/24, то данные нужно отправить на устройство с адресом 172.16.2.2.  
Таблица маршрутизации формируется из:  
— непосредственно подключенных сетей \(directly connected\) — это сети, которые начинаются непосредственно на нём. В примере 172.16.3.0/24 и 172.16.2.0/30. В таблице они обозначаются буквой **C**  
— статический маршруты — это те, которые вы прописали вручную командой **ip route**. Обозначаются буквой **S**  
— маршруты, полученные с помощью протоколов динамической маршрутизации \(OSPF, EIGRP, RIP и других\).

7\) Итак, данные в сеть 172.16.17.0 \(а мы хотим подключиться к устройству 172.16.17.1\) должны быть отправлены на следующий хоп — следующий прыжок, которым является маршрутизатор 172.16.2.2. Причём из таблицы маршрутизации видно, что находится следующий хоп за интерфейсом FE0/1.4 \(подсеть 172.16.2.0/30\).  
8\)Если в ARP-кэше циски нет MAC-адреса, то надо снова выполнить ARP-запрос, чтобы узнать MAC-адрес устройства с IP-адресом 172.16.2.2. RT1 посылает широковещательный кадр с порта FE0/1.4. В этом широковещательном домене у нас два устройства, и соответственно только один получатель. RT2 получает ARP-запрос, отбрасывает заголовок Ethernet и, понимая из данных протокола ARP, что искомый адрес принадлежит ему отправляет ARP-ответ со своим MAC-адресом.  
9\) Изначальный IP-пакет, пришедший на RT1 **не меняется**, он инкапсулируется в **совершенно новый кадр** и отправляется в порт FE0/1.4, получая при этом метку 4-го влана.  
10\) Полностью аналогичные действия происходят на следующем маршрутизаторе. И на следующем и следующем \(если бы они были\), пока пакет не дойдёт до последнего, к которому и подключена нужная сеть.  
11\) Последний маршрутизатор \(коим является L3-коммутатор\) видит, что искомый адрес принадлежит ему самому, а извлекая данные транспортного уровня, понимает, что это телнет и передаёт все данные верхним уровням.

Так вот и путешествуют данные с одного хопа на другой и ни один маршрутизатор представления не имеет о дальнейшей судьбе пакета. Более того, он даже не знает есть ли там действительно эта сеть — он просто доверяет своей таблице маршрутизации.

